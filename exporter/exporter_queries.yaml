# 檔案: ./prometheus/exporter_queries.yaml

queries:
  # --- 1. 實時預測與策略指標 ---
  - name: lstm_realtime_prediction
    query: |
      SELECT
        timestamp_to AS time_bucket,
        predicted_power_w AS predicted_power_w,
        predicted_co2_kg AS predicted_co2_kg,
        -- 將策略等級轉換為數值：HIGH=3, MID=2, LOW=1 (供 Grafana 指示燈使用)
        CASE (recommended_strategy->>'load_level') 
          WHEN 'HIGH' THEN 3
          WHEN 'MID' THEN 2
          ELSE 1
        END AS load_level_metric
      FROM carbon_emissions
      ORDER BY timestamp_to DESC 
      LIMIT 1;
    master: true
    metrics:
      - predicted_power_w:
          usage: "GAUGE"
          description: "LSTM predicted power in Watts (W)"
          labels: [time_bucket]
      - predicted_co2_kg:
          usage: "GAUGE"
          description: "LSTM predicted CO2 in kilograms (kg)"
          labels: [time_bucket]
      - load_level_metric:
          usage: "GAUGE"
          description: "AI strategy load level (1=LOW, 2=MID, 3=HIGH)"
          labels: [time_bucket]

  # --- 2. 歷史性能指標 (用於 RMSE/MAE 計算) ---
  - name: lstm_daily_performance
    query: |
      WITH comparison AS (
        SELECT
          m.system_power_watt AS actual_w,
          p.predicted_power_w AS predicted_w
        FROM energy_cleaned m
        JOIN carbon_emissions p ON DATE_TRUNC('minute', CAST(m.timestamp_utc AS timestamp with time zone)) = p.timestamp_to
        WHERE CAST(m.timestamp_utc AS timestamp with time zone) >= NOW() - INTERVAL '24 hours'
          AND CAST(m.timestamp_utc AS timestamp with time zone) < NOW()
      )
      SELECT
        AVG(ABS(predicted_w - actual_w)) AS mae_w,
        SQRT(AVG(POWER(predicted_w - actual_w, 2))) AS rmse_w
      FROM comparison;
    master: true
    metrics:
      - mae_w:
          usage: "GAUGE"
          description: "Mean Absolute Error (W) over 24 hours"
      - rmse_w:
          usage: "GAUGE"
          description: "Root Mean Square Error (W) over 24 hours"